---
title: "Actividad práctica 3: Pruebas de hipótesis y comparación de grupos"
subtitle: "Facultad de Economía, Universidad de los Andes"
author: "Camila Caraballo, Laura Rivera y Javier Amaya Nieto"
date: "2025-10-15"
output: html_document
---

# Setup del ambiente

```{r, include=FALSE}
# Instalando pacman si se requier
if (!require("pacman")) install.packages("pacman")

# Cargando los paquetes usando pacman
pacman::p_load(
  
  # A) Manipulación, limpieza y visualización de datos
  tidyverse,    # Colección de paquetes esenciales (incluye dplyr, ggplot2, etc.)
  forcats,      # Herramientas para trabajar con variables categóricas (factores).
  tibble,       # Implementación moderna de data.frames.
  janitor,      # Limpieza de nombres de variables y tablas de frecuencia.
  lubridate,    # Manejo avanzado de fechas y horas.
  skimr,        # Resúmenes estadísticos completos y rápidos de data.frames.
  stringi,      # Manipulación robusta de texto (strings).
  scales,       # Formato de escalas en ggplot2 (ej. porcentajes, comas).
  openxlsx,     # Guardar excel
  writexl,      # Guardar excel

  # B) Modelado y análisis estadístico/econométrico
  fixest,       # Estimación de modelos de efectos fijos de alto rendimiento.
  plm,          # Modelos econométricos para datos de panel.
  AER,          # Herramientas para econometría aplicada (ej. variables instrumentales).
  lmtest,       # Pruebas de hipótesis para modelos de regresión (ej. coeftest).
  sandwich,     # Cálculo de errores estándar robustos a heterocedasticidad.
  survey,       # Análisis de datos de encuestas complejas (ponderación, estratificación).

  # C) Importación, exportación y generación de reportes
  haven,        # Lectura y escritura de formatos de Stata, SAS y SPSS.
  readxl,       # Lectura de archivos de Excel (.xls y .xlsx).
  stargazer,    # Creación de tablas de regresión con formato de publicación.
  knitr,        # Generación de reportes dinámicos.
  ggrepel,
  ggpar,
)
```

# Objetivo

Usando datos del Banco Mundial (World Development Indicators) se deben comparar las emisiones de CO₂ per cápita entre países con PIB per cápita alto y bajo, estimar la diferencia promedio, su error estándar y un intervalo de confianza del 95 %, para posteriormente evaluar si la diferencia observada es estadísticamente significativa mediante una prueba de hipótesis bilateral o unilateral, según la justificación teórica.

# Parte 1: Planteamiento conceptual y formulación de hipótesis

#### Contextualización

Explique brevemente por qué es plausible pensar que el nivel de ingreso de los países podría asociarse con sus emisiones per cápita.

• ¿Qué teorías o intuiciones respaldan esta relación?

• ¿Qué razones podrían llevar a que no exista una diferencia real?

#### Formulación

Formule el contraste de hipótesis: Defina la hipótesis nula (H₀) y la alternativa (H₁). Justifique si el contraste debe ser bilateral (interesa cualquier diferencia) o unilateral (interesa una dirección específica: mayor contaminación en países ricos)

#### Especificación

Especifique cuál sería la consecuencia de cometer un error tipo I (falso positivo) o un error t ipo II (falso negativo), en este contexto.

#### Definición de indicadores

```{r}
### 1. LIMPIEZA DE DATOS

# Importar datos de PIB y CO2 ------------------------------------
pib_file <- file.path(path, "PIB.xls")
co2_file <- file.path(path, "CO2.xls")

data_pib <- read_excel(pib_file, sheet = "Data", skip = 3) %>% clean_names()
data_co2 <- read_excel(co2_file, sheet = "Data", skip = 3) %>% clean_names()

# Seleccionar columnas de interés para 2023 ---------------------
pib_2023 <- data_pib %>%
  select(country_code, pib_2023 = x2023)

co2_2023 <- data_co2 %>%
  select(country_code, co2_2023 = x2023)

# Integrar datasets por código de país -------------------------
data_join <- left_join(pib_2023, co2_2023, by = "country_code") %>%
  drop_na()

# Clasificación: Alto vs. Bajo PIB -----------------------------
data_join <- data_join %>%
  mutate(grupo_pib = if_else(
    pib_2023 >= median(pib_2023, na.rm = TRUE),
    "Alto PIB per cápita",
    "Bajo PIB per cápita"
  ))

# Separando los DF --------------------------------------------
d1 <- data_join %>% filter(grupo_pib=="Alto PIB per cápita")
d2 <- data_join %>% filter(grupo_pib=="Bajo PIB per cápita")
```

# Parte 2: Evidencia empírica y estimación

#### Descripción breve de los datos

Número de países, año de referencia, valores mínimos y máximos de PIB y CO₂ per cápita. Esto es el análisis univariado que permite conocer las particularidades de los datos con los que va a trabajar. 2. Estadísticas descriptivas de cada grupo.

```{r}
### 2. ANALISIS UNIVARIADO Y ESTADÍSTICAS

# Resumen descriptivo- Tabla     ----------------------------------
analisis_univariado <- data_join %>%
  summarise(
    n_paises = n_distinct(country_code),
    anio_referencia = 2023,
    min_pib = min(pib_2023, na.rm = TRUE),
    max_pib = max(pib_2023, na.rm = TRUE),
    min_co2 = min(co2_2023, na.rm = TRUE),
    max_co2 = max(co2_2023, na.rm = TRUE)
  )

print(analisis_univariado)

# Estadísticas descriptivas por grupo de PIB- Tabla  --------------
resumen <- data_join %>%
  group_by(grupo_pib) %>%
  summarise(
    n_paises = n_distinct(country_code),
    promedio_pib = mean(pib_2023, na.rm = TRUE),
    sd_pib = sd(pib_2023, na.rm = TRUE),
    min_pib = min(pib_2023, na.rm = TRUE),
    max_pib = max(pib_2023, na.rm = TRUE),
    promedio_co2 = mean(co2_2023, na.rm = TRUE),
    sd_co2 = sd(co2_2023, na.rm = TRUE),
    min_co2 = min(co2_2023, na.rm = TRUE),
    max_co2 = max(co2_2023, na.rm = TRUE)
  )

print(resumen)

# Gráficos 

# Gráfico 1: Correlación PIB y CO2
g1 <- ggplot(data_join, aes(x = pib_2023, y = co2_2023, color = grupo_pib)) +
  geom_point(alpha = 0.8, size = 3) +
  geom_smooth(method = "lm", se = FALSE, color = "#003366", linetype = "dashed") +
  scale_x_log10(labels = scales::comma) +
  scale_y_log10(labels = scales::comma) +
  scale_color_manual(values = c("#003366", "#336699", "#6699CC", "#99CCFF")) +
  labs(
    title = "Relación entre PIB per cápita y emisiones de CO2 per cápita",
    subtitle = "Correlación",
    x = "PIB per cápita (USD, log)",
    y = "CO2 per cápita (toneladas, log)",
    color = "Grupo de PIB"
  ) +
  theme_minimal(base_size = 13, base_family = "Helvetica") +
  theme(panel.grid = element_blank(),
        plot.title = element_text(face = "bold", color = "#003366"),
        axis.title = element_text(face = "bold", color = "#003366"),
        legend.position = "bottom")

ggsave("Graficos/g1.png", g1, width = 8, height = 6, dpi = 300)

# Gráfico 2: Top 10 países con mayor CO2 per cápita
top_co2 <- data_join %>%
  arrange(desc(co2_2023)) %>%
  slice_head(n = 10)

g2 <- ggplot(top_co2, aes(x = reorder(country_code, co2_2023), y = co2_2023)) +
  geom_col(fill = "#003366") +
  coord_flip() +
  labs(
    title = "Top 10 países con mayores emisiones de CO2 per cápita",
    x = "País",
    y = "CO2 per cápita (toneladas)"
  ) +
  theme_minimal(base_size = 13, base_family = "Helvetica") +
  theme(panel.grid = element_blank(),
        plot.title = element_text(face = "bold", color = "#003366"),
        axis.title = element_text(face = "bold", color = "#003366"))

ggsave("Graficos/g2.png", g2, width = 8, height = 6, dpi = 300)

# ============================================================
# Gráfico 3: Correlación en los países con mayor PIB o CO2
# ============================================================
top_paises <- data_join %>%
  arrange(desc(pib_2023)) %>% slice_head(n = 10) %>%
  bind_rows(data_join %>% arrange(desc(co2_2023)) %>% slice_head(n = 10)) %>%
  distinct(country_code, .keep_all = TRUE)

g3 <- ggplot(top_paises, aes(x = pib_2023, y = co2_2023, label = country_code)) +
  geom_point(size = 3, alpha = 0.8, color = "#003366") +
  geom_smooth(method = "lm", se = FALSE, color = "gray40", linetype = "dashed") +
  ggrepel::geom_text_repel(size = 3, color = "black") +
  labs(
    title = "Relación entre PIB per cápita y CO2 per cápita",
    subtitle = "Países con mayores valores de PIB y emisiones de CO2 per cápita",
    x = "PIB per cápita (2023)",
    y = "CO2 per cápita (2023)"
  ) +
  theme_minimal(base_size = 13, base_family = "Helvetica") +
  theme(panel.grid = element_blank(),
        plot.title = element_text(face = "bold", color = "#003366"),
        axis.title = element_text(face = "bold", color = "#003366"))

ggsave("Graficos/g3.png", g3, width = 8, height = 6, dpi = 300)

```

#### Estimación de la diferencia promedio de emisiones entre los grupos

Interprete el sentido y magnitud de la diferencia (¿cuánto más emiten los países de PIB alto?).Estime un intervalo de confianza del 95 % para esa diferencia usando un procedimiento Bootstrap y una prueba t. ¿Qué diferencia hay entre los resultados de Bootstrap y la prueba t?

```{r}
### 3. DIFERENCIA PROMEDIO 

# Paso 0. Diferencia promedio 
dif_media <- mean(d1$co2_2023, na.rm = TRUE) - mean(d2$co2_2023, na.rm = TRUE)

cat("Diferencia promedio de emisiones (PIB alto - PIB bajo):",
    round(dif_media, 3), "\n")

# Paso 1. Función de media para bootstrap (por grupo)
boot_mean <- function(data, indices) {
  d <- data[indices, ]              
  mean(d$co2_2023, na.rm = TRUE)
}

# Paso 2. Función que devuelve media e IC95% (BCa y Percentil)
summarize_boot_both <- function(df, etiqueta, R = 10000, seed = 123){
  set.seed(seed)
  b  <- boot::boot(df, statistic = boot_mean, R = R)
  ci <- boot::boot.ci(b, type = c("bca", "perc"))
  
  tibble::tibble(
    grupo_pib      = etiqueta,
    n_paises       = nrow(df),
    mean_co2       = mean(df$co2_2023, na.rm = TRUE),
    boot_R         = R,
    ic95_low_bca   = ifelse(!is.null(ci$bca), ci$bca[4], NA_real_),
    ic95_high_bca  = ifelse(!is.null(ci$bca), ci$bca[5], NA_real_),
    ic95_low_perc  = ifelse(!is.null(ci$percent), ci$percent[4], NA_real_),
    ic95_high_perc = ifelse(!is.null(ci$percent), ci$percent[5], NA_real_)
  )
}

# Paso 3. Aplicar a cada grupo (Alto / Bajo PIB)
tabla_ic_wide <- dplyr::bind_rows(
  summarize_boot_both(d1, "Alto PIB per cápita"),
  summarize_boot_both(d2, "Bajo PIB per cápita")
) %>%
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 3)))

print(tabla_ic_wide)

# Paso 4. Bootstrap de la DIFERENCIA de medias
boot_diff <- function(data, indices) {
  d <- data[indices, ]
  mean(d$co2_2023[d$grupo_pib == "Alto PIB per cápita"], na.rm = TRUE) -
    mean(d$co2_2023[d$grupo_pib == "Bajo PIB per cápita"], na.rm = TRUE)
}

set.seed(123)
boot_diff_res <- boot::boot(data_join, statistic = boot_diff, R = 10000)
ci_diff <- boot::boot.ci(boot_diff_res, type = c("bca", "perc"))

cat("\n=== Bootstrap diferencia de medias (Alto - Bajo PIB) ===\n")
cat("Diferencia promedio:", round(mean(boot_diff_res$t), 3), "\n")
cat("IC95% Percentil:", round(ci_diff$percent[4], 3), "a", round(ci_diff$percent[5], 3), "\n")
cat("IC95% BCa:", round(ci_diff$bca[4], 3), "a", round(ci_diff$bca[5], 3), "\n\n")

# Paso 5. Prueba t clásica para comparación
t_test_res <- t.test(co2_2023 ~ grupo_pib, data = data_join, var.equal = FALSE)

cat("=== Prueba t clásica ===\n")
cat("Media PIB alto:", round(t_test_res$estimate[1], 3), "\n")
cat("Media PIB bajo:", round(t_test_res$estimate[2], 3), "\n")
cat("Diferencia de medias:", round(t_test_res$estimate[1] - t_test_res$estimate[2], 3), "\n")
cat("IC95%:", round(t_test_res$conf.int[1], 3), "a", round(t_test_res$conf.int[2], 3), "\n")
cat("p-valor:", round(t_test_res$p.value, 4), "\n")

# Gráfico de distribución bootstrap
g4 <- ggplot(data = tibble(diff = boot_diff_res$t), aes(x = diff)) +
  geom_histogram(aes(y = ..density..), bins = 50, fill = "#5B8FA8", alpha = 0.6, color = "white") +
  geom_density(color = "#003366", size = 1.2) +
  geom_vline(xintercept = mean(boot_diff_res$t), color = "#003366", size = 1.3) +
  geom_vline(xintercept = c(ci_diff$percent[4], ci_diff$percent[5]), color = "#1B4F72", linetype = "dashed", size = 1) +
  geom_vline(xintercept = c(ci_diff$bca[4], ci_diff$bca[5]), color = "#2874A6", linetype = "dotted", size = 1) +
  labs(
    title = "Distribución de la diferencia de emisiones(PIB alto - PIB bajo)",
    x = "Diferencia de medias de CO2 per cápita",
    y = "Densidad"
  ) +
  theme_minimal(base_size = 13, base_family = "Helvetica") +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(face = "bold", color = "#003366", size = 14),
    plot.subtitle = element_text(color = "#1B4F72", size = 11),
    axis.title = element_text(face = "bold", color = "#003366"),
    axis.text = element_text(color = "gray20")
  )

ggsave("Graficos/g4.png", g4, width = 8, height = 6, dpi = 300)

```

El gráfico evidencia una relación positiva clara entre el nivel de ingreso y las emisiones per cápita. Los países con PIB alto emiten, en promedio, unas 6 toneladas más de CO₂ por persona que los países con PIB bajo, con alta confianza estadística (95%).

#### Evaluación de la evidencia

-   Determine si el intervalo de confianza incluye o no el valor 0.

```{r}
# Verificar si el intervalo bootstrap incluye el 0
ic_low <- ci_diff$bca[4]
ic_high <- ci_diff$bca[5]

incluye_cero <- (ic_low <= 0 & ic_high >= 0)

cat("¿El IC95% bootstrap incluye el valor 0?:", incluye_cero, "\n")
cat("IC95% BCa =", round(ic_low, 3), "a", round(ic_high, 3), "\n\n")
```

-   Reporte el p-valor de la prueba de hipótesis y explique qué significa en términos del riesgo de error tipo I.

```{r}
#  Obtener p-valor de la prueba t
p_valor <- t_test_res$p.value

cat("p-valor de la prueba t:", format(p_valor, scientific = TRUE, digits = 5), "\n")

if (p_valor < 0.05) {
  cat("→ Se rechaza H0 al 5% de significancia. Evidencia de diferencia significativa.\n")
} else {
  cat("→ No se rechaza H0 al 5%. No hay evidencia de diferencia significativa.\n")
}

```

-   Verifique si el resultado de la prueba y el intervalo conducen a la misma conclusión.

```{r}
if (!incluye_cero & p_valor < 0.05) {
  cat("\n✅ Ambos métodos (Bootstrap y prueba t) llevan a la misma conclusión: \n")
  cat("   los países de PIB alto emiten significativamente más CO₂ per cápita.\n")
} else {
  cat("\n⚠️ Los resultados no son completamente consistentes entre métodos.\n")
}
```

# Parte 3: Interpretación y reflexión sobre la decisión estadística

#### Análisis

Si el resultado fue significativo, ¿qué implicaría en términos de política ambiental o desarrollo sostenible? Si no fue significativo, ¿significa que no existe relación o que la evidencia no es suficiente?

#### Reflexión

Describa qué sería un falso positivo y un falso negativo en este estudio, y cuáles consecuencias tendría cada uno.

¿Qué factores metodológicos (tamaño de muestra, variabilidad, agrupación) influyen en la probabilidad de cometer estos errores?

#### Conclusión sobre la robustez

¿Cómo podría mejorarse el análisis (más datos, otras variables, nuevos años, ponderaciones)?

¿Qué limitaciones debemos reconocer al generalizar estos resultados?
