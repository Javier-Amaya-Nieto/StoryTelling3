---
title: "Actividad práctica 3: Pruebas de hipótesis y comparación de grupos"
subtitle: "Facultad de Economía, Universidad de los Andes"
author: "Camila Caraballo, Laura Rivera y Javier Amaya Nieto"
date: "2025-10-15"
output: html_document
---

# Setup del ambiente

```{r, include=FALSE}
# Instalando pacman si se requier
if (!require("pacman")) install.packages("pacman")

# Cargando los paquetes usando pacman
pacman::p_load(
  
  # A) Manipulación, limpieza y visualización de datos
  tidyverse,    # Colección de paquetes esenciales (incluye dplyr, ggplot2, etc.)
  forcats,      # Herramientas para trabajar con variables categóricas (factores).
  tibble,       # Implementación moderna de data.frames.
  janitor,      # Limpieza de nombres de variables y tablas de frecuencia.
  lubridate,    # Manejo avanzado de fechas y horas.
  skimr,        # Resúmenes estadísticos completos y rápidos de data.frames.
  stringi,      # Manipulación robusta de texto (strings).
  scales,       # Formato de escalas en ggplot2 (ej. porcentajes, comas).
  openxlsx,     # Guardar excel
  writexl,      # Guardar excel

  # B) Modelado y análisis estadístico/econométrico
  fixest,       # Estimación de modelos de efectos fijos de alto rendimiento.
  plm,          # Modelos econométricos para datos de panel.
  AER,          # Herramientas para econometría aplicada (ej. variables instrumentales).
  lmtest,       # Pruebas de hipótesis para modelos de regresión (ej. coeftest).
  sandwich,     # Cálculo de errores estándar robustos a heterocedasticidad.
  survey,       # Análisis de datos de encuestas complejas (ponderación, estratificación).

  # C) Importación, exportación y generación de reportes
  haven,        # Lectura y escritura de formatos de Stata, SAS y SPSS.
  readxl,       # Lectura de archivos de Excel (.xls y .xlsx).
  stargazer,    # Creación de tablas de regresión con formato de publicación.
  knitr         # Generación de reportes dinámicos.
)

# Cargar archivo Excel (Leer la PRIMERA hoja del Excel)
data0 <- read_excel("data/World_bank_indicadors.xlsx", sheet = 1)
```

# Objetivo

Usando datos del Banco Mundial (World Development Indicators) se deben comparar las emisiones de CO₂ per cápita entre países con PIB per cápita alto y bajo, estimar la diferencia promedio, su error estándar y un intervalo de confianza del 95 %, para posteriormente evaluar si la diferencia observada es estadísticamente significativa mediante una prueba de hipótesis bilateral o unilateral, según la justificación teórica.

# Parte 1: Planteamiento conceptual y formulación de hipótesis

#### Contextualización

Explique brevemente por qué es plausible pensar que el nivel de ingreso de los países podría asociarse con sus emisiones per cápita.

• ¿Qué teorías o intuiciones respaldan esta relación?

• ¿Qué razones podrían llevar a que no exista una diferencia real?

#### Formulación

Formule el contraste de hipótesis: Defina la hipótesis nula (H₀) y la alternativa (H₁). Justifique si el contraste debe ser bilateral (interesa cualquier diferencia) o unilateral (interesa una dirección específica: mayor contaminación en países ricos)

#### Especificación

Especifique cuál sería la consecuencia de cometer un error tipo I (falso positivo) o un error t ipo II (falso negativo), en este contexto.

#### Definición de indicadores

```{r}
### 1. LIMPIEZA DE DATOS

# Convertir a data frame
data0 <- as.data.frame(data0)

# Renombrar columnas a nombres válidos
colnames(data0) <- make.names(colnames(data0))

# Reemplazar ".." por NA y convertir a numérico
data0 <- data0 %>%
  mutate(valor_2023 = na_if(X2023..YR2023., ".."),
         valor_2023 = as.numeric(gsub(",", ".", valor_2023)))

# Agrupar, filtrar países sin NA, desagrupar
data1 <- data0 %>%
  group_by(Country.Name) %>%
  filter(!any(is.na(valor_2023))) %>%
  ungroup()

### 2. ORGANIZAR LA BASE POR LAS VARIABLES DE CLASIFICAICÓN (X)

# Dividemos la base de datos en 2 grupos tomando en cuenta la media del PIB per cápita 

####Explique por qué usa ese criterio (hace falta)

# 1. Calcular la media del PIB per cápita
media_pib <- data1 %>%
  filter(Series.Name == "GDP per capita (current US$)") %>%
  summarise(media = mean(valor_2023, na.rm = TRUE)) %>%
  pull(media)

# 2. Crear tabla de clasificación por país (solo usando PIB)
clasificacion <- data1 %>%
  filter(Series.Name == "GDP per capita (current US$)") %>%
  mutate(
    grupo_pib = if_else(valor_2023 < media_pib, 0, 1)
  ) %>%
  select(Country.Name, grupo_pib)

# 3. Unir esa clasificación a la base original
data1 <- data1 %>%
  left_join(clasificacion, by = "Country.Name")

# 4. Verificar resultado
data1 %>%
  arrange(Country.Name, Series.Name) %>%
  select(Country.Name, Series.Name, valor_2023, grupo_pib) %>%
  head(10)

# Nos quedamos solo con las variables de interés
data2 <- data1 %>%
  select(Country.Name, Series.Name, valor_2023, grupo_pib)

### 3. FILTRAR VARIABLES DE INTERES 

# Filtrar solo observaciones de CO2
data_co2 <- data2 %>%
  filter(grepl("CO2", Series.Name, ignore.case = TRUE)) %>%   # busca solo "CO2"
  filter(!is.na(grupo_pib) & !is.na(valor_2023)) %>%
  mutate(grupo_pib = as.integer(grupo_pib))

# Revisar tamaños y medias por grupo
data_co2 %>% group_by(grupo_pib) %>% 
  summarise(n = n(), 
            mean = mean(valor_2023), 
            sd = sd(valor_2023))
```

# Parte 2: Evidencia empírica y estimación

#### Descripción breve de los datos

Número de países, año de referencia, valores mínimos y máximos de PIB y CO₂ per cápita. Esto es el análisis univariado que permite conocer las particularidades de los datos con los que va a trabajar. 2. Estadísticas descriptivas de cada grupo.

```{r}
### 4. ANALISIS UNIVARIADO Y ESTADÍSTICAS

# Número total de países en la base
num_paises <- length(unique(data2$Country.Name))
cat("Número total de países en la base:", num_paises, "\n")

# Año de referencia (ya definido en la columna 'valor_2023')
cat("Año de referencia de los datos: 2023\n")

# Valores mínimos y máximos del PIB per cápita (US$ corrientes)
pib_summary <- data2 %>%
  filter(Series.Name == "GDP per capita (current US$)") %>%
  summarise(
    min_pib = min(valor_2023, na.rm = TRUE),
    max_pib = max(valor_2023, na.rm = TRUE),
    mean_pib = mean(valor_2023, na.rm = TRUE),
    sd_pib = sd(valor_2023, na.rm = TRUE)
  )

print(pib_summary)

# Valores mínimos y máximos de emisiones de CO₂ per cápita
co2_summary <- data2 %>%
  filter(grepl("CO2", Series.Name, ignore.case = TRUE)) %>%
  summarise(
    min_co2 = min(valor_2023, na.rm = TRUE),
    max_co2 = max(valor_2023, na.rm = TRUE),
    mean_co2 = mean(valor_2023, na.rm = TRUE),
    sd_co2 = sd(valor_2023, na.rm = TRUE)
  )

print(co2_summary)

# Estadísticas descriptivas de CO₂ por grupo de ingreso
stats_grupo <- data_co2 %>%
  group_by(grupo_pib) %>%
  summarise(
    n_paises = n_distinct(Country.Name),
    media_CO2 = mean(valor_2023, na.rm = TRUE),
    mediana_CO2 = median(valor_2023, na.rm = TRUE),
    sd_CO2 = sd(valor_2023, na.rm = TRUE),
    min_CO2 = min(valor_2023, na.rm = TRUE),
    max_CO2 = max(valor_2023, na.rm = TRUE)
  ) %>%
  mutate(
    grupo = ifelse(grupo_pib == 0, "PIB bajo", "PIB alto")
  ) %>%
  select(grupo, everything(), -grupo_pib)
print(stats_grupo)

```

#### Estimación de la diferencia promedio de emisiones entre los grupos

Interprete el sentido y magnitud de la diferencia (¿cuánto más emiten los países de PIB alto?).Estime un intervalo de confianza del 95 % para esa diferencia usando un procedimiento Bootstrap y una prueba t. ¿Qué diferencia hay entre los resultados de Bootstrap y la prueba t?

```{r}
### 5. DIFERENCIA PROMEDIO 

set.seed(1234)   # reproducibilidad

# Separar los grupos
x0 <- data_co2 %>% filter(grupo_pib == 0) %>% pull(valor_2023)   # PIB bajo
x1 <- data_co2 %>% filter(grupo_pib == 1) %>% pull(valor_2023)   # PIB alto

# Calcular diferencia promedio (PIB alto - PIB bajo)
obs_diff <- mean(x1, na.rm = TRUE) - mean(x0, na.rm = TRUE)

cat("DIFERENCIA PROMEDIO DE EMISIONES ENTRE GRUPOS\n")
cat("------------------------------------------------------------\n")
cat("Promedio PIB bajo :", round(mean(x0, na.rm = TRUE), 3), "ton CO₂ per cápita\n")
cat("Promedio PIB alto :", round(mean(x1, na.rm = TRUE), 3), "ton CO₂ per cápita\n")
cat("Diferencia observada (PIB alto - PIB bajo):", round(obs_diff, 3), "\n")
```

```{r}
# PARTE 6 — DIFERENCIA DE EMISIONES ENTRE GRUPOS DE PIB
set.seed(1234)   # Reproducibilidad

# 1. ESTADÍSTICAS POR GRUPO Y PRUEBA T
# Calcular estadísticas básicas por grupo
res_param <- data_co2 %>%
  group_by(grupo_pib) %>%
  summarise(
    n = n(),
    media = mean(valor_2023, na.rm = TRUE),
    sd = sd(valor_2023, na.rm = TRUE),
    se_param = sd / sqrt(n),
    tcrit = qt(0.975, df = n - 1),
    CI_low_param = media - tcrit * se_param,
    CI_high_param = media + tcrit * se_param
  )

cat("Resumen de estadísticas por grupo:\n")
print(res_param)

# Prueba t de diferencia de medias (PIB alto vs PIB bajo)
t_test <- t.test(valor_2023 ~ grupo_pib, data = data_co2, var.equal = FALSE)

cat("\nPrueba t de diferencia de medias:\n")
print(t_test)

# Extraer valores clave de la prueba t
ci_t_low  <- t_test$conf.int[1]
ci_t_high <- t_test$conf.int[2]
p_valor_t <- t_test$p.value


# 7. ESTIMACIÓN CON BOOTSTRAP
B <- 1000  # Número de replicaciones bootstrap
boot_stats <- data.frame(grupo = integer(),
                         boot_se = numeric(),
                         CI_lo = numeric(),
                         CI_hi = numeric())

# Estimación bootstrap por grupo
for (g in sort(unique(data_co2$grupo_pib))) {
  x <- data_co2 %>% filter(grupo_pib == g) %>% pull(valor_2023)
  n <- length(x)
  boot_means <- replicate(B, mean(sample(x, size = n, replace = TRUE)))
  boot_se <- sd(boot_means)
  ci <- quantile(boot_means, c(0.025, 0.975))
  boot_stats <- rbind(boot_stats,
                      data.frame(grupo = g, boot_se = boot_se, CI_lo = ci[1], CI_hi = ci[2]))
}

cat("\nIntervalos bootstrap por grupo:\n")
print(boot_stats)

# 8. BOOTSTRAP PARA LA DIFERENCIA DE MEDIAS
# Definir los grupos
x0 <- data_co2 %>% filter(grupo_pib == 0) %>% pull(valor_2023)
x1 <- data_co2 %>% filter(grupo_pib == 1) %>% pull(valor_2023)
n0 <- length(x0); n1 <- length(x1)

# Diferencia observada
obs_diff <- mean(x1) - mean(x0)

# Bootstrap de la diferencia
boot_diff <- replicate(B, {
  m0 <- mean(sample(x0, size = n0, replace = TRUE))
  m1 <- mean(sample(x1, size = n1, replace = TRUE))
  m1 - m0
})

# Estadísticos bootstrap
boot_diff_se <- sd(boot_diff)
boot_diff_ci <- quantile(boot_diff, c(0.025, 0.975))
p_boot <- mean(abs(boot_diff) >= abs(obs_diff))

# Resultados resumidos de la diferencia
diff_results <- data.frame(
  estadistico = c("obs_diff","boot_se","boot_CI_lo","boot_CI_hi","p_boot_two_sided"),
  valor = c(obs_diff, boot_diff_se, boot_diff_ci[1], boot_diff_ci[2], p_boot)
)

cat("\nResultados bootstrap para la diferencia de medias:\n")
print(diff_results)

# 9. EVALUACIÓN DE LA EVIDENCIA
# Verificar si los intervalos incluyen 0
incluye_cero_t <- (ci_t_low <= 0 & ci_t_high >= 0)
incluye_cero_boot <- (boot_diff_ci[1] <= 0 & boot_diff_ci[2] >= 0)

evaluacion <- data.frame(
  Metodo = c("Prueba t", "Bootstrap"),
  Lim_inf_CI = c(ci_t_low, boot_diff_ci[1]),
  Lim_sup_CI = c(ci_t_high, boot_diff_ci[2]),
  Incluye_0 = c(incluye_cero_t, incluye_cero_boot),
  p_valor = c(p_valor_t, p_boot)
)

cat("\nEvaluación de la evidencia:\n")
print(evaluacion)

# 10. VISUALIZACIÓN DEL BOOTSTRAP
hist_df <- data.frame(boot_diff = boot_diff)

ggplot(hist_df, aes(x = boot_diff)) +
  geom_histogram(bins = 60, fill = "gray80", color = "white") +
  geom_vline(xintercept = obs_diff, color = "red", linetype = "dashed") +
  geom_vline(xintercept = boot_diff_ci, color = "blue") +
  labs(title = "Distribución bootstrap de la diferencia (PIB alto - PIB bajo)",
       subtitle = paste0("Diferencia observada = ", round(obs_diff, 3),
                         "; 95% CI Boot = [", round(boot_diff_ci[1],3), ", ", round(boot_diff_ci[2],3), "]"),
       x = "Diferencia en medias de CO₂ per cápita", y = "Frecuencia") +
  theme_minimal()

# 11. RESUMEN FINAL
cat("\nResumen final:\n")
cat(sprintf("Grupo 0: n=%d, media=%.4f, CI_boot=[%.4f, %.4f]\n",
            n0, mean(x0), boot_stats$CI_lo[boot_stats$grupo==0], boot_stats$CI_hi[boot_stats$grupo==0]))
cat(sprintf("Grupo 1: n=%d, media=%.4f, CI_boot=[%.4f, %.4f]\n",
            n1, mean(x1), boot_stats$CI_lo[boot_stats$grupo==1], boot_stats$CI_hi[boot_stats$grupo==1]))
cat(sprintf("Diferencia observada (grupo1 - grupo0) = %.4f\n", obs_diff))
cat(sprintf("IC (t) = [%.4f, %.4f]\n", ci_t_low, ci_t_high))
cat(sprintf("IC (Bootstrap) = [%.4f, %.4f]\n", boot_diff_ci[1], boot_diff_ci[2]))
cat(sprintf("p-valor (t) = %.4f\n", p_valor_t))
cat(sprintf("p-valor (Bootstrap) = %.4f\n", p_boot))

```

#### Evaluación de la evidencia

-   Determine si el intervalo de confianza incluye o no el valor 0.

-   Reporte el p-valor de la prueba de hipótesis y explique qué significa en términos del riesgo de error tipo I.

-   Verifique si el resultado de la prueba y el intervalo conducen a la misma conclusión.

# Parte 3: Interpretación y reflexión sobre la decisión estadística

#### Análisis

Si el resultado fue significativo, ¿qué implicaría en términos de política ambiental o desarrollo sostenible? Si no fue significativo, ¿significa que no existe relación o que la evidencia no es suficiente?

#### Reflexión

Describa qué sería un falso positivo y un falso negativo en este estudio, y cuáles consecuencias tendría cada uno.

¿Qué factores metodológicos (tamaño de muestra, variabilidad, agrupación) influyen en la probabilidad de cometer estos errores?

#### Conclusión sobre la robustez

¿Cómo podría mejorarse el análisis (más datos, otras variables, nuevos años, ponderaciones)?

¿Qué limitaciones debemos reconocer al generalizar estos resultados?
